<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Approval Test</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Admin Approval Workflow Test</h1>
        
        <div class="test-section">
            <h3>1. Test Deposit Submission</h3>
            <p>This simulates a user submitting a deposit request:</p>
            <button class="test-button" onclick="testDepositSubmission()">Submit Test Deposit</button>
            <div id="depositResult"></div>
        </div>

        <div class="test-section">
            <h3>2. Test Admin Approval</h3>
            <p>This simulates an admin approving the deposit:</p>
            <button class="test-button" onclick="testAdminApproval()">Approve Test Deposit</button>
            <div id="approvalResult"></div>
        </div>

        <div class="test-section">
            <h3>3. Test User Notification Check</h3>
            <p>This simulates checking for user notifications:</p>
            <button class="test-button" onclick="testNotificationCheck()">Check Notifications</button>
            <div id="notificationResult"></div>
        </div>

        <div class="test-section">
            <h3>4. Workflow Status</h3>
            <div id="workflowStatus">Click the buttons above to test each step...</div>
        </div>
    </div>

    <script src="js/user-notifications.js"></script>
    <script>
        // Test functions
        let testDepositData = null;

        function testDepositSubmission() {
            const resultDiv = document.getElementById('depositResult');
            
            // Create a test deposit request
            testDepositData = {
                userId: 'test_user_123',
                userName: 'Test User',
                phone: '+256700123456',
                email: 'test@example.com',
                amount: 50000,
                level: 'intern',
                levelDisplayName: 'Intern Level',
                accountName: 'Test User',
                accountPhone: '+256700123456',
                screenshot: 'test_screenshot.jpg',
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            // Set user data in localStorage for testing
            localStorage.setItem('currentUser', testDepositData.userId);
            localStorage.setItem('userPhone', testDepositData.phone);
            localStorage.setItem('userName', testDepositData.userName);

            resultDiv.innerHTML = `
                <div class="success">
                    ✅ Test deposit request created:
                    <br>User: ${testDepositData.userName}
                    <br>Amount: UGX ${testDepositData.amount.toLocaleString()}
                    <br>Level: ${testDepositData.levelDisplayName}
                    <br>Status: ${testDepositData.status}
                </div>
            `;
            
            updateWorkflowStatus('step1');
        }

        async function testAdminApproval() {
            const resultDiv = document.getElementById('approvalResult');
            
            if (!testDepositData) {
                resultDiv.innerHTML = '<div class="error">❌ Please submit a test deposit first!</div>';
                return;
            }

            try {
                // Simulate admin approval
                const approvalData = {
                    ...testDepositData,
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    adminNotes: 'Test approval'
                };

                // Create a test notification (simulating what admin approval would do)
                const notification = {
                    userId: approvalData.userId,
                    type: 'deposit_approved',
                    message: `✅ Payment approved! Your ${approvalData.levelDisplayName} has been activated.`,
                    depositRequest: approvalData,
                    createdAt: new Date().toISOString(),
                    read: false
                };

                // Store in localStorage for testing (normally would go to GitHub)
                const notifications = JSON.parse(localStorage.getItem('test_notifications') || '[]');
                notifications.push(notification);
                localStorage.setItem('test_notifications', JSON.stringify(notifications));

                resultDiv.innerHTML = `
                    <div class="success">
                        ✅ Test approval completed:
                        <br>Status: ${approvalData.status}
                        <br>Approved At: ${new Date(approvalData.approvedAt).toLocaleString()}
                        <br>Notification Created: Yes
                    </div>
                `;
                
                updateWorkflowStatus('step2');
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Approval failed: ${error.message}</div>`;
            }
        }

        async function testNotificationCheck() {
            const resultDiv = document.getElementById('notificationResult');
            
            try {
                // Check for test notifications
                const notifications = JSON.parse(localStorage.getItem('test_notifications') || '[]');
                const currentUser = localStorage.getItem('currentUser');
                const userNotifications = notifications.filter(n => 
                    n.userId === currentUser && !n.read && n.type === 'deposit_approved'
                );

                if (userNotifications.length > 0) {
                    const notification = userNotifications[0];
                    
                    // Simulate showing the notification
                    showTestNotification(notification.message, 'success');
                    
                    // Mark as read
                    notification.read = true;
                    localStorage.setItem('test_notifications', JSON.stringify(notifications));
                    
                    // Update user level
                    if (notification.depositRequest) {
                        localStorage.setItem('userLevel', notification.depositRequest.level);
                        localStorage.setItem('taskAccess', 'true');
                    }

                    resultDiv.innerHTML = `
                        <div class="success">
                            ✅ Notification found and processed:
                            <br>Message: ${notification.message}
                            <br>Level Updated: ${notification.depositRequest.levelDisplayName}
                            <br>Task Access: Activated
                        </div>
                    `;
                    
                    updateWorkflowStatus('step3');
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ⚠️ No notifications found for current user.
                            <br>User ID: ${currentUser}
                            <br>Total notifications: ${notifications.length}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Notification check failed: ${error.message}</div>`;
            }
        }

        function showTestNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `test-notification notification-${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 20px',
                borderRadius: '8px',
                color: 'white',
                fontSize: '0.9rem',
                fontWeight: '500',
                zIndex: '10001',
                maxWidth: '400px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                backgroundColor: type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'
            });
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function updateWorkflowStatus(step) {
            const statusDiv = document.getElementById('workflowStatus');
            let status = '';
            
            switch(step) {
                case 'step1':
                    status = '🟡 Step 1 Complete: Deposit submitted ➜ Next: Admin approval';
                    break;
                case 'step2':
                    status = '🟡 Step 2 Complete: Admin approved ➜ Next: User notification check';
                    break;
                case 'step3':
                    status = '🟢 Workflow Complete! User received approval notification and level updated';
                    break;
            }
            
            statusDiv.innerHTML = `<div class="success">${status}</div>`;
        }

        // Initialize test environment
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Admin Approval Test Page Loaded');
            console.log('User Notification Checker:', window.userNotificationChecker ? 'Loaded' : 'Not Loaded');
        });
    </script>
</body>
</html>